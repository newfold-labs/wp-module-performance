document.addEventListener("DOMContentLoaded",(()=>{const{__}=wp.i18n,e="nfd-bulk-optimize-btn";let t=!1;const n=["button","media-button","select-mode-toggle-button"],o=["button","media-button","button-primary","button-large","delete-selected-button"],r=e=>e.getAttribute("aria-label"),a=async()=>{const e=Array.from(document.querySelectorAll(".attachment.selected")).map((e=>({id:e.getAttribute("data-id"),name:r(e)})));if(!e.length)return;const n=window.nfdPerformance?.imageOptimization?.bulkOptimizer?.apiUrl;if(!n)return;const{progressBar:o,modalTitle:a,currentFileName:i,resultList:d,doneButton:s,progressContainer:l}=(()=>{t=!1;const{progressBar:e,modalTitle:n,currentFileName:o,resultList:r,doneButton:a,progressContainer:i}=(()=>{const e=document.createElement("div");e.id="nfd-bulk-modal",e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n        ";const t=document.createElement("div");t.style.cssText="\n            background: white;\n            padding: 2rem;\n            border-radius: 8px;\n            text-align: center;\n            width: 400px;\n            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);\n        ";const n=document.createElement("h2");n.id="nfd-modal-title",n.textContent=__("Optimizing Images…","wp-module-performance");const o=document.createElement("p");o.id="nfd-current-file",o.textContent=__("Preparing files…","wp-module-performance");const r=document.createElement("div");r.id="nfd-progress-container",r.style.cssText="\n            width: 100%;\n            height: 20px;\n            background: #eee;\n            border-radius: 10px;\n            margin: 1rem 0;\n            overflow: hidden;\n            position: relative;\n        ";const a=document.createElement("div");a.id="nfd-progress-bar",a.style.cssText="\n            height: 100%;\n            width: 0;\n            background: #007cba;\n            transition: width 0.3s ease;\n        ";const i=document.createElement("ul");i.id="nfd-result-list",i.style.cssText="\n            text-align: center;\n            margin: 1rem auto;\n            max-height: 200px;\n            overflow-y: auto;\n        ";const d=document.createElement("button");return d.textContent=__("Done","wp-module-performance"),d.className="button button-secondary",d.style.marginTop="1rem",d.style.display="none",d.addEventListener("click",(()=>{e.remove()})),r.appendChild(a),t.append(n,o,r,i,d),e.appendChild(t),document.body.appendChild(e),{modal:e,progressBar:a,modalTitle:n,currentFileName:o,resultList:i,doneButton:d,progressContainer:r}})();return e.style.width="0%",o.textContent="",{progressBar:e,modalTitle:n,currentFileName:o,resultList:r,doneButton:a,progressContainer:i}})(),c=[];try{for(let r=0;r<e.length;r++){if(t){a.textContent=__("Optimization Canceled","wp-module-performance");break}const{id:d,name:s}=e[r];i.textContent=__("Optimizing:","wp-module-performance")+` ${s}`;try{await wp.apiFetch({url:n,method:"POST",data:{media_id:parseInt(d,10)}}),c.push({name:s,status:"passed"})}catch(e){c.push({name:s,status:"failed"})}const l=(r+1)/e.length*100;o.style.width=`${l}%`}a.textContent=__("Optimization Complete!","wp-module-performance"),l.style.display="none",i.style.display="none",c.forEach((({name:e,status:t})=>{const n=document.createElement("li"),o=__("passed"===t?"Passed":"Failed","wp-module-performance");n.textContent=`${e} - ${o}`,d.appendChild(n)})),d.style.textAlign="center",s.style.display="block"}catch(e){a.textContent=__("An error occurred.","wp-module-performance")}},i=e=>{const t=()=>{const t=document.querySelectorAll(".attachment.selected").length>0;e.disabled=!t},n=document.querySelector(".media-frame-content");n&&(new MutationObserver(t).observe(n,{childList:!0,subtree:!0}),t())},d=(e,t)=>e?.classList.length===t.length&&t.every((t=>e.classList.contains(t)));new MutationObserver((()=>{const t=document.querySelector(".button.media-button.select-mode-toggle-button");d(t,n)?(()=>{const t=document.getElementById(e);t&&t.remove()})():(()=>{if(document.getElementById(e))return;const t=document.querySelector(".button.media-button.button-primary.button-large.delete-selected-button");if(!d(t,o))return;const n=(()=>{const t=document.createElement("button");return t.id=e,t.className="button media-button button-large button-primary",t.textContent=__("Optimize","wp-module-performance"),t.disabled=!0,t.addEventListener("click",a),t})();t.parentElement.insertBefore(n,t.nextSibling),i(n)})()})).observe(document.body,{childList:!0,subtree:!0})}));