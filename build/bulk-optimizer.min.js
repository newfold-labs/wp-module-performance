document.addEventListener("DOMContentLoaded",(()=>{const{__:e}=wp.i18n,t="nfd-bulk-optimize-btn";let n=!1;const o=["button","media-button","select-mode-toggle-button"],r=["button","media-button","button-primary","button-large","delete-selected-button"],a=()=>{n=!1;const{progressBar:t,modalTitle:o,currentFileName:r,resultList:a,doneButton:i,progressContainer:d}=(()=>{const t=document.createElement("div");t.id="nfd-bulk-modal",t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n        ";const n=document.createElement("div");n.style.cssText="\n            background: white;\n            padding: 2rem;\n            border-radius: 8px;\n            text-align: center;\n            width: 400px;\n            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);\n        ";const o=document.createElement("h2");o.id="nfd-modal-title",o.textContent=e("Optimizing Images…","wp-module-performance");const r=document.createElement("p");r.id="nfd-current-file",r.textContent=e("Preparing files…","wp-module-performance");const a=document.createElement("div");a.id="nfd-progress-container",a.style.cssText="\n            width: 100%;\n            height: 20px;\n            background: #eee;\n            border-radius: 10px;\n            margin: 1rem 0;\n            overflow: hidden;\n            position: relative;\n        ";const i=document.createElement("div");i.id="nfd-progress-bar",i.style.cssText="\n            height: 100%;\n            width: 0;\n            background: #007cba;\n            transition: width 0.3s ease;\n        ";const d=document.createElement("ul");d.id="nfd-result-list",d.style.cssText="\n            text-align: center;\n            margin: 1rem auto;\n            max-height: 200px;\n            overflow-y: auto;\n        ";const s=document.createElement("button");return s.textContent=e("Done","wp-module-performance"),s.className="button button-secondary",s.style.marginTop="1rem",s.style.display="none",s.addEventListener("click",(()=>{t.remove()})),a.appendChild(i),n.append(o,r,a,d,s),t.appendChild(n),document.body.appendChild(t),{modal:t,progressBar:i,modalTitle:o,currentFileName:r,resultList:d,doneButton:s,progressContainer:a}})();return t.style.width="0%",r.textContent="",{progressBar:t,modalTitle:o,currentFileName:r,resultList:a,doneButton:i,progressContainer:d}},i=e=>e.getAttribute("aria-label"),d=async()=>{const t=Array.from(document.querySelectorAll(".attachment.selected")).map((e=>({id:e.getAttribute("data-id"),name:i(e)})));if(!t.length)return;const o=window.nfdPerformance?.imageOptimization?.bulkOptimizer?.apiUrl;if(!o)return;const{progressBar:r,modalTitle:d,currentFileName:s,resultList:l,doneButton:c,progressContainer:m}=a(),u=[];try{for(let a=0;a<t.length;a++){if(n){d.textContent=e("Optimization Canceled","wp-module-performance");break}const{id:i,name:l}=t[a];s.textContent=e("Optimizing:","wp-module-performance")+` ${l}`;try{await wp.apiFetch({url:o,method:"POST",data:{media_id:parseInt(i,10)}}),u.push({name:l,status:"passed"})}catch(e){u.push({name:l,status:"failed"})}const c=(a+1)/t.length*100;r.style.width=`${c}%`}d.textContent=e("Optimization Complete!","wp-module-performance"),m.style.display="none",s.style.display="none",u.forEach((({name:t,status:n})=>{const o=document.createElement("li"),r=e("passed"===n?"Passed":"Failed","wp-module-performance");o.textContent=`${t} - ${r}`,l.appendChild(o)})),l.style.textAlign="center",c.style.display="block"}catch(t){d.textContent=e("An error occurred.","wp-module-performance")}},s=()=>{if(document.getElementById(t))return;const n=document.querySelector(".button.media-button.button-primary.button-large.delete-selected-button");if(!c(n,r))return;const o=(()=>{const n=document.createElement("button");return n.id=t,n.className="button media-button button-large button-primary",n.textContent=e("Optimize","wp-module-performance"),n.disabled=!0,n.addEventListener("click",d),n})();n.parentElement.insertBefore(o,n.nextSibling),l(o)},l=e=>{const t=()=>{const t=document.querySelectorAll(".attachment.selected").length>0;e.disabled=!t},n=document.querySelector(".media-frame-content");n&&(new MutationObserver(t).observe(n,{childList:!0,subtree:!0}),t())},c=(e,t)=>e?.classList.length===t.length&&t.every((t=>e.classList.contains(t)));new MutationObserver((()=>{const e=document.querySelector(".button.media-button.select-mode-toggle-button");c(e,o)?(()=>{const e=document.getElementById(t);e&&e.remove()})():s()})).observe(document.body,{childList:!0,subtree:!0})}));