(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const{__}=wp.i18n,e="nfd-bulk-optimize-btn";let t=!1;const n=["button","media-button","select-mode-toggle-button"],o=["button","media-button","button-primary","button-large","delete-selected-button"],r=()=>{t=!1;const{progressBar:e,modalTitle:n,currentFileName:o,resultList:r,doneButton:a,progressContainer:d}=(()=>{const e=document.createElement("div");e.id="nfd-bulk-modal",e.className="nfd-performance-image-modal";const t=document.createElement("div");t.className="nfd-performance-image-modal-content";const n=document.createElement("h2");n.id="nfd-modal-title",n.textContent=__("Optimizing Images…","wp-module-performance");const o=document.createElement("p");o.id="nfd-current-file",o.textContent=__("Preparing files…","wp-module-performance");const r=document.createElement("div");r.id="nfd-progress-container",r.className="nfd-performance-image-progress-container";const a=document.createElement("div");a.id="nfd-progress-bar",a.className="nfd-performance-image-progress-bar";const d=document.createElement("ul");d.id="nfd-result-list",d.className="nfd-performance-image-result-list";const s=document.createElement("button");return s.textContent=__("Done","wp-module-performance"),s.className="button button-secondary nfd-performance-image-done-button",s.style.display="none",s.addEventListener("click",(()=>{e.remove(),window.location.reload()})),r.appendChild(a),t.append(n,o,r,d,s),e.appendChild(t),document.body.appendChild(e),{modal:e,progressBar:a,modalTitle:n,currentFileName:o,resultList:d,doneButton:s,progressContainer:r}})();return e.style.width="0%",o.textContent="",{progressBar:e,modalTitle:n,currentFileName:o,resultList:r,doneButton:a,progressContainer:d}},a=e=>e.getAttribute("aria-label"),d=async()=>{const e=Array.from(document.querySelectorAll(".attachment.selected")).map((e=>({id:e.getAttribute("data-id"),name:a(e)})));if(!e.length)return;const n=window.nfdPerformance?.imageOptimization?.bulkOptimizer?.apiUrl;if(!n)return;const{progressBar:o,modalTitle:d,currentFileName:s,resultList:c,doneButton:i,progressContainer:l}=r(),m=[];try{for(let r=0;r<e.length;r++){if(t){d.textContent=__("Optimization Canceled","wp-module-performance");break}const{id:a,name:c}=e[r];s.textContent=__("Optimizing:","wp-module-performance")+` ${c}`;try{await wp.apiFetch({url:n,method:"POST",data:{media_id:parseInt(a,10)}}),m.push({name:c,status:"passed"})}catch(e){m.push({name:c,status:"failed"})}const i=(r+1)/e.length*100;o.style.width=`${i}%`}d.textContent=__("Optimization Complete!","wp-module-performance"),l.style.display="none",s.style.display="none",m.forEach((({name:e,status:t})=>{const n=document.createElement("li"),o=__("passed"===t?"Passed":"Failed","wp-module-performance");n.textContent=`${e} - ${o}`,c.appendChild(n)})),i.style.display="block"}catch(e){d.textContent=__("An error occurred.","wp-module-performance")}},s=()=>{if(document.getElementById(e))return;const t=document.querySelector(".button.media-button.button-primary.button-large.delete-selected-button");if(!i(t,o))return;const n=(()=>{const t=document.createElement("button");return t.id=e,t.className="button media-button button-large button-primary",t.textContent=__("Optimize","wp-module-performance"),t.disabled=!0,t.addEventListener("click",d),t})();t.parentElement.insertBefore(n,t.nextSibling),c(n)},c=e=>{const t=()=>{const t=document.querySelectorAll(".attachment.selected").length>0;e.disabled=!t},n=document.querySelector(".media-frame-content");if(n){new MutationObserver(t).observe(n,{childList:!0,subtree:!0}),t()}},i=(e,t)=>e?.classList.length===t.length&&t.every((t=>e.classList.contains(t)));new URLSearchParams(window.location.search);if(window.location.search.indexOf("autoSelectBulk")>=0){const e=new MutationObserver((()=>{const t=document.querySelector(".button.media-button.select-mode-toggle-button");t&&(t.click(),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}new MutationObserver((()=>{const t=document.querySelector(".button.media-button.select-mode-toggle-button");i(t,n)?(()=>{const t=document.getElementById(e);t&&t.remove()})():s()})).observe(document.body,{childList:!0,subtree:!0})}))})();