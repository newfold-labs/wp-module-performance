(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const{__:e}=wp.i18n,t="nfd-bulk-optimize-btn";let n=!1;const o=["button","media-button","select-mode-toggle-button"],r=["button","media-button","button-primary","button-large","delete-selected-button"],a=()=>{n=!1;const{progressBar:t,modalTitle:o,currentFileName:r,resultList:a,doneButton:d,progressContainer:s}=(()=>{const t=document.createElement("div");t.id="nfd-bulk-modal",t.className="nfd-performance-image-modal";const n=document.createElement("div");n.className="nfd-performance-image-modal-content";const o=document.createElement("h2");o.id="nfd-modal-title",o.textContent=e("Optimizing Images…","wp-module-performance");const r=document.createElement("p");r.id="nfd-current-file",r.textContent=e("Preparing files…","wp-module-performance");const a=document.createElement("div");a.id="nfd-progress-container",a.className="nfd-performance-image-progress-container";const d=document.createElement("div");d.id="nfd-progress-bar",d.className="nfd-performance-image-progress-bar";const s=document.createElement("ul");s.id="nfd-result-list",s.className="nfd-performance-image-result-list";const c=document.createElement("button");return c.textContent=e("Done","wp-module-performance"),c.className="button button-secondary nfd-performance-image-done-button",c.style.display="none",c.addEventListener("click",(()=>{t.remove(),window.location.reload()})),a.appendChild(d),n.append(o,r,a,s,c),t.appendChild(n),document.body.appendChild(t),{modal:t,progressBar:d,modalTitle:o,currentFileName:r,resultList:s,doneButton:c,progressContainer:a}})();return t.style.width="0%",r.textContent="",{progressBar:t,modalTitle:o,currentFileName:r,resultList:a,doneButton:d,progressContainer:s}},d=e=>e.getAttribute("aria-label"),s=async()=>{const t=Array.from(document.querySelectorAll(".attachment.selected")).map((e=>({id:e.getAttribute("data-id"),name:d(e)})));if(!t.length)return;const o=window.nfdPerformance?.imageOptimization?.bulkOptimizer?.apiUrl;if(!o)return;const{progressBar:r,modalTitle:s,currentFileName:c,resultList:i,doneButton:l,progressContainer:m}=a(),u=[];try{for(let a=0;a<t.length;a++){if(n){s.textContent=e("Optimization Canceled","wp-module-performance");break}const{id:d,name:i}=t[a];c.textContent=e("Optimizing:","wp-module-performance")+` ${i}`;try{await wp.apiFetch({url:o,method:"POST",data:{media_id:parseInt(d,10)}}),u.push({name:i,status:"passed"})}catch(e){u.push({name:i,status:"failed"})}const l=(a+1)/t.length*100;r.style.width=`${l}%`}s.textContent=e("Optimization Complete!","wp-module-performance"),m.style.display="none",c.style.display="none",u.forEach((({name:t,status:n})=>{const o=document.createElement("li"),r=e("passed"===n?"Passed":"Failed","wp-module-performance");o.textContent=`${t} - ${r}`,i.appendChild(o)})),l.style.display="block"}catch(t){s.textContent=e("An error occurred.","wp-module-performance")}},c=()=>{if(document.getElementById(t))return;const n=document.querySelector(".button.media-button.button-primary.button-large.delete-selected-button");if(!l(n,r))return;const o=(()=>{const n=document.createElement("button");return n.id=t,n.className="button media-button button-large button-primary",n.textContent=e("Optimize","wp-module-performance"),n.disabled=!0,n.addEventListener("click",s),n})();n.parentElement.insertBefore(o,n.nextSibling),i(o)},i=e=>{const t=()=>{const t=document.querySelectorAll(".attachment.selected").length>0;e.disabled=!t},n=document.querySelector(".media-frame-content");if(n){new MutationObserver(t).observe(n,{childList:!0,subtree:!0}),t()}},l=(e,t)=>e?.classList.length===t.length&&t.every((t=>e.classList.contains(t)));if("true"===new URLSearchParams(window.location.search).get("autoSelectBulk")){const e=new MutationObserver((()=>{const t=document.querySelector(".button.media-button.select-mode-toggle-button");t&&(t.click(),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}new MutationObserver((()=>{const e=document.querySelector(".button.media-button.select-mode-toggle-button");l(e,o)?(()=>{const e=document.getElementById(t);e&&e.remove()})():c()})).observe(document.body,{childList:!0,subtree:!0})}))})();